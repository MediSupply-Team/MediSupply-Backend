name: ğŸ›°ï¸ Update Nginx (Oracle Cloud)

on:
  # Se dispara automÃ¡ticamente despuÃ©s de deploy exitoso
  # workflow_run:
  #   workflows: 
  #     - "Deploy BFF Venta Service"
  #     - "Deploy Route Optimizer Service"
  #   types: [completed]
  #   branches: [develop]
  
  # TambiÃ©n puedes ejecutarlo manualmente
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy"
        required: false
        default: "develop"
  push:
      branches:
        - develop
      paths:
        - '.github/workflows/update-nginx-oracle.yml'

env:
  AWS_REGION: us-east-1

jobs:
  update-nginx:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::217466752988:role/github-actions-deploy
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get ALB DNS Names from AWS
        id: alb-dns
        run: |
          echo "ğŸ” Obteniendo DNS de ALBs en AWS..."
          
          # Obtener DNS de BFF Venta
          BFF_VENTA_DNS=$(aws elbv2 describe-load-balancers \
            --region ${{ env.AWS_REGION }} \
            --query "LoadBalancers[?contains(LoadBalancerName, 'medisupply-dev-bff-venta')].DNSName" \
            --output text)
          
          # Obtener DNS de BFF Cliente
          BFF_CLIENTE_DNS=$(aws elbv2 describe-load-balancers \
            --region ${{ env.AWS_REGION }} \
            --query "LoadBalancers[?contains(LoadBalancerName, 'medisupply-dev-bff-cliente')].DNSName" \
            --output text)
          
          # Validar que se obtuvieron los DNS
          if [ -z "$BFF_VENTA_DNS" ]; then
            echo "âŒ Error: No se pudo obtener DNS de BFF Venta"
            exit 1
          fi
          
          if [ -z "$BFF_CLIENTE_DNS" ]; then
            echo "âŒ Error: No se pudo obtener DNS de BFF Cliente"
            exit 1
          fi
          
          # Guardar en outputs
          echo "bff_venta=$BFF_VENTA_DNS" >> $GITHUB_OUTPUT
          echo "bff_cliente=$BFF_CLIENTE_DNS" >> $GITHUB_OUTPUT
          
          # Mostrar resultados
          echo "âœ… DNS obtenidos exitosamente:"
          echo "   BFF Venta:   $BFF_VENTA_DNS"
          echo "   BFF Cliente: $BFF_CLIENTE_DNS"
      
      - name: Update Nginx Config on Oracle Cloud
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_SSH_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            set -e
            
            echo "================================"
            echo "ğŸ”§ Actualizando Nginx en Oracle Cloud"
            echo "================================"
            
            # Limpiar backups antiguos de sites-enabled
            echo "ğŸ§¹ Limpiando backups antiguos de sites-enabled..."
            sudo rm -f /etc/nginx/sites-enabled/default.backup.*
            
            # Crear directorio para backups si no existe
            mkdir -p ~/nginx-backups
            
            # Crear backup con timestamp en directorio home
            BACKUP_FILE="$HOME/nginx-backups/default.backup.$(date +%Y%m%d_%H%M%S)"
            echo "ğŸ“¦ Creando backup: $BACKUP_FILE"
            sudo cp /etc/nginx/sites-enabled/default "$BACKUP_FILE"
            
            # Mostrar configuraciÃ³n actual
            echo ""
            echo "ğŸ“‹ ConfiguraciÃ³n actual:"
            grep "proxy_pass.*medisupply" /etc/nginx/sites-enabled/default | head -5
            
            # Actualizar BFF Venta
            echo ""
            echo "ğŸ”„ Actualizando BFF Venta ALB..."
            sudo sed -i 's|proxy_pass http://medisupply-dev-bff-venta-alb-[0-9]*\.us-east-1\.elb\.amazonaws\.com|proxy_pass http://${{ steps.alb-dns.outputs.bff_venta }}|g' /etc/nginx/sites-enabled/default
            
            # Actualizar BFF Cliente
            echo "ğŸ”„ Actualizando BFF Cliente ALB..."
            sudo sed -i 's|proxy_pass http://medisupply-dev-bff-cliente-alb-[0-9]*\.us-east-1\.elb\.amazonaws\.com|proxy_pass http://${{ steps.alb-dns.outputs.bff_cliente }}|g' /etc/nginx/sites-enabled/default
            
            # Mostrar nueva configuraciÃ³n
            echo ""
            echo "ğŸ“‹ Nueva configuraciÃ³n:"
            grep "proxy_pass.*medisupply" /etc/nginx/sites-enabled/default | head -5
            
            # Validar configuraciÃ³n
            echo ""
            echo "âœ… Validando configuraciÃ³n Nginx..."
            if sudo nginx -t; then
              echo "âœ… ConfiguraciÃ³n vÃ¡lida"
            else
              echo "âŒ ConfiguraciÃ³n invÃ¡lida, restaurando backup..."
              sudo cp "$BACKUP_FILE" /etc/nginx/sites-enabled/default
              exit 1
            fi
            
            # Recargar Nginx
            echo ""
            echo "ğŸ”„ Recargando Nginx..."
            sudo systemctl reload nginx
            
            # Verificar estado
            echo ""
            echo "ğŸ” Verificando estado de Nginx..."
            sudo systemctl status nginx --no-pager | head -10
            
            # Mantener solo Ãºltimos 10 backups
            echo ""
            echo "ğŸ§¹ Limpiando backups antiguos..."
            ls -t ~/nginx-backups/default.backup.* 2>/dev/null | tail -n +11 | xargs -r rm
            
            echo ""
            echo "================================"
            echo "ğŸ‰ Nginx actualizado exitosamente!"
            echo "================================"
      
      - name: Verify Nginx endpoints
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_SSH_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          script: |
            echo "ğŸ§ª Probando endpoints..."
            
            # Test endpoint raÃ­z
            echo ""
            echo "ğŸ“ Testing: https://medisupply-backend.duckdns.org/"
            curl -s -k https://localhost/ | jq . || echo "âŒ Endpoint raÃ­z fallÃ³"
            
            # Test health endpoint venta
            echo ""
            echo "ğŸ“ Testing: /venta/health"
            curl -s -k https://localhost/venta/health | jq . || echo "âŒ Health venta fallÃ³"
            
            echo ""
            echo "âœ… Tests completados"
      
      - name: Send notification on success
        if: success()
        run: |
          echo "âœ… Nginx actualizado exitosamente en Oracle Cloud"
          echo "ğŸ”— BFF Venta:   ${{ steps.alb-dns.outputs.bff_venta }}"
          echo "ğŸ”— BFF Cliente: ${{ steps.alb-dns.outputs.bff_cliente }}"
      
      - name: Send notification on failure
        if: failure()
        run: |
          echo "âŒ Error al actualizar Nginx en Oracle Cloud"
          echo "âš ï¸  Revisa los logs y la configuraciÃ³n"